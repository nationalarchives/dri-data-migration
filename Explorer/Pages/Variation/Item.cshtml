@page "/variation/{id}"
@model Explorer.Pages.Variation.ItemModel

<partial name="SubsetBreadcrumbPartial" model="@Model.Item.Asset.Single().Subset.Single().Broader" />

<section class="row tna-!--margin-top-m tna-column tna-column--full">
    <h1>Variation @Model.Item.Name.Single()</h1>
    <dl class="tna-dl tna-dl--plain">
        <dt>DRI Id</dt>
        <dd>@Model.Item.Id.Single()</dd>
        @if (Model.Item.Note.Any())
        {
            <dt>Note</dt>
            <dd>@Model.Item.Note.Single()</dd>
        }
        @if (Model.Item.Location.Any())
        {
            <dt>Location</dt>
            <dd>@Model.Item.Location.Single().Value</dd>
        }
    </dl>

    @if (Model.Item.Redacted.Any())
    {
        <div class="tna-!--margin-top-m">
            <h2>Redacted versions</h2>
            <ul class="tna-ul tna-ul--dashed">
                @foreach (var redacted in Model.Item.Redacted)
                {
                    <li>
                        <p>
                            <a asp-page="/variation/item" asp-route-id="@redacted.Id.Single()">@redacted.Name.Single()</a>
                        </p>
                    </li>
                }
            </ul>
        </div>
    }

    <div class="tna-!--margin-top-m">
        <h2>Asset <a asp-page="/asset/item" asp-route-id="@Model.Item.Asset.Single().Reference.Single()">@Model.Item.Asset.Single().Reference.Single()</a></h2>
    </div>

    @if (Model.Item.SensitivityReviews.Any())
    {
        <div class="tna-!--margin-top-m">
            <h2>Sensitivity reviews</h2>
            <ul class="tna-ul tna-ul--dashed">
                @foreach (var sr in Model.Item.SensitivityReviews)
                {
                    <li>
                        <p>
                            <a asp-page="/sensitivityreview/item" asp-route-id="@sr.DriId.Single()">@sr.DriId.Single()</a>
                        </p>
                        <partial name="SensitivityReviewPartial" model="@sr" />
                    </li>
                }
            </ul>
        </div>
    }
</section>

<section class="tna-container tna-!--margin-top-m">
    <div class="tna-column tna-column--full">
        <div class="tna-form__group">
            <textarea class="tna-textarea" rows="25" readonly>@System.Text.UTF8Encoding.UTF8.GetString(Convert.FromBase64String(Model.Item.Xml.Single().Value))</textarea>
        </div>
    </div>
</section>

<section class="tna-container tna-!--margin-top-m">
    <div class="tna-column tna-column--full">
        <div class="tna-form__group">
            @{
                var variation = Model.Item;
                var asset = variation.Asset.Single();
                var srLast = variation.SensitivityReviews.Single(s => !Model.Item.SensitivityReviews.Any(past => past.Past.SingleOrDefault()?.DriId == s.DriId));
                var period = srLast.Restriction.SingleOrDefault().EndYear.SingleOrDefault();
                if (period is null)
                {
                    var duration = srLast.Restriction.SingleOrDefault().Duration.SingleOrDefault();
                    if (duration is not null)
                    {
                        period = duration.Value.Days / 365;
                    }
                }
                var simple = new Models.SimpleVariation(asset.Reference.Single(),
                    asset.Id.Single(), variation.Id.Single(),
                    asset.Retention.SingleOrDefault()?.RetentionBody.SingleOrDefault()?.Name.SingleOrDefault(),
                    variation.Name.Single(), asset.Description.SingleOrDefault(),
                    asset.Copyright.SingleOrDefault()?.Title.SingleOrDefault(),
                    asset.Creation.SingleOrDefault()?.CreationBody.SingleOrDefault()?.Name.SingleOrDefault(),
                    variation.Location.SingleOrDefault()?.Value, asset.ConsignmentId.SingleOrDefault(),
                    asset.BatchId.SingleOrDefault(),
                    asset.LegalStatus.SingleOrDefault()?.Uri.Segments.Last(),
                    srLast.AccessCondition.SingleOrDefault()?.Name.SingleOrDefault(),
                    srLast.Restriction.SingleOrDefault()?.UkLegislations.SelectMany(uk => uk.Reference),
                    period, srLast.Restriction.SingleOrDefault()?.CalculationStartDate.SingleOrDefault(),
                    srLast.Restriction.SingleOrDefault()?.ReviewDate.SingleOrDefault(), srLast.Date.SingleOrDefault());

                var options = new System.Text.Json.JsonSerializerOptions()
                {
                    PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase,
                    WriteIndented = true,
                    DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull
                };
                var json = System.Text.Json.JsonSerializer.Serialize(simple, options);
                <textarea class="tna-textarea" rows="25" readonly>@json</textarea>
            }
        </div>
    </div>
</section>